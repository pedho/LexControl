<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LexControl</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* altura mínima para os containers dos charts */
      #chartTotalAdvogados, #chartCasosPorStatus, #chartConcluidosPorAdvogado, #chartPendentesPorAdvogado {
        min-height: 320px;
      }
    </style>
  </head>
  <body>
    <%- include("../partials/_navbar") %>

    <% if (success_msg && success_msg.length > 0) { %>
      <% success_msg.forEach(msg => { %>
        <div class="alert alert-success"><%= msg %></div>
      <% }) %>
    <% } %>
    <% if (error_msg && error_msg.length > 0) { %>
      <% error_msg.forEach(msg => { %>
        <div class="alert alert-danger"><%= msg %></div>
      <% }) %>
    <% } %>
    

    <div class="container mt-4">
      <h3 class="mb-3">Painel de Controle</h3>

      <div class="card m-2 p-3 mb-4">
        <% if (!Audiencias || Audiencias.length === 0) { %>
            <p class="text-muted mb-0">Nenhuma audiência marcada para os próximos 7 dias.</p>
        <% } else { %>
            <p class="m-2">Audiências nos próximos 7 dias:</p>
            <div>
              <% Audiencias.forEach(a => { %>
                <div class="card p-3 mb-2">
                  <div><strong>Data:</strong> <%= new Date(a.data).toLocaleDateString("pt-BR") %> <strong>em</strong> <%= a.local %></div>
                  <small>
                    <strong>Caso:</strong> <%= a.caso.titulo %> — 
                    <strong>Cliente:</strong> <%= a.caso.cliente.nome %> — 
                    <strong>Advogado:</strong> <%= a.caso.advogado_responsavel ? a.caso.advogado_responsavel.nome : "Não atribuído" %>
                  </small>
                </div>
              <% }) %>
            </div>
        <% } %>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div id="chartTotalAdvogados"></div>
        </div>
        <div class="col-md-8">
          <div id="chartCasosPorStatus"></div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div id="chartConcluidosPorAdvogado"></div>
        </div>
        <div class="col-md-6">
          <div id="chartPendentesPorAdvogado"></div>
        </div>
      </div>

    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.3/dist/apexcharts.min.js"></script>

    <script>
      
      const totalAdvogados = <%- JSON.stringify(totalAdvogados || 0) %>;
      const casosPorStatus = <%- JSON.stringify(casosPorStatus || []) %>;
      const advogados_nomes = <%- JSON.stringify(advogados_nomes || []) %>;
      const concluidosArray = <%- JSON.stringify(concluidosArray || []) %>;
      const pendentesArray = <%- JSON.stringify(pendentesArray || []) %>;

      document.addEventListener('DOMContentLoaded', function () {
        
        const chart1 = new ApexCharts(document.querySelector("#chartTotalAdvogados"), {
          chart: { type: 'donut' },
          labels: ['Advogados cadastrados'],
          series: [totalAdvogados],
          title: { text: 'Total de Advogados' }
        });
        chart1.render();

        
        const categoriesStatus = casosPorStatus.map(c => c.status);
        const dataStatus = casosPorStatus.map(c => c._count.status);

        const chart2 = new ApexCharts(document.querySelector("#chartCasosPorStatus"), {
          chart: { type: 'bar', height: 320 },
          series: [{ name: 'Casos', data: dataStatus }],
          xaxis: { categories: categoriesStatus },
          title: { text: 'Casos por Status' }
        });
        chart2.render();

        
        const chart3 = new ApexCharts(document.querySelector("#chartConcluidosPorAdvogado"), {
          chart: { type: 'bar', height: 300 },
          series: [{ name: 'Concluídos', data: concluidosArray }],
          xaxis: { categories: advogados_nomes },
          title: { text: 'Casos Concluídos por Advogado' }
        });
        chart3.render();

        
        const chart4 = new ApexCharts(document.querySelector("#chartPendentesPorAdvogado"), {
          chart: { type: 'bar', height: 300 },
          series: [{ name: 'Em andamento', data: pendentesArray }],
          xaxis: { categories: advogados_nomes },
          title: { text: 'Casos em andamento por Advogado' }
        });
        chart4.render();
      });
    </script>
  </body>
</html>
